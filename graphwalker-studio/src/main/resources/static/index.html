<html>
<head>
    <meta charset=utf-8/>

    <script type="text/javascript" src="dist/jquery-1.11.3.min.js"></script>

    <script type="text/javascript" src="dist/jquery-ui.min.js"></script>
    <link href="dist/jquery-ui.css" type="text/css" rel="stylesheet"/>

    <script type="text/javascript" src="dist/cytoscape.js"></script>


    <script type="text/javascript" src="dist/cytoscape.js"></script>

    <script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.1.2/cytoscape-dagre.js"></script>

    <style type="text/css">
        body {
            font: 14px helvetica neue, helvetica, arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #tabs {
            position: absolute;
            top: 0;
            bottom:0;
            left: 0;
            right: 0;
            overflow:hidden;
        }

        #tabs div {
            height: 100%;
        }

        #tabs li .ui-icon-close {
            float: left;
            margin: 0.4em 0.2em 0 0;
            cursor: pointer;
        }

        .ui-tabs .ui-tabs-panel {
            padding: 0;
        }

    </style>
</head>
<body>
<div id="tabs">
    <ul></ul>
</div>
</body>
<script>
    // Hash array that holds all graphs/models.
    var graphs =[];

    document.addEventListener('DOMContentLoaded', function () {

        $("#tabs").delegate("span.ui-icon-close", "click", function () {
            var id = $(this).closest("li").remove().attr("aria-controls").substr(2);
            $("#A-" + id).remove();
            $("#tabs").tabs("refresh");
            if ($("#tabs").find("li").length < 1) {
                $("#tabs").hide();
            }
            graphs[id] = undefined;
        });

        $('#tabs').tabs({
            activate: function (event, ui) {
                var modelId = ui.newPanel.attr('id').substr(2);
                console.log("tabs activate: " + modelId);
                graphs[modelId].resize();
                if (graphs[modelId].doLayout) {
                    graphs[modelId].layout();
                    graphs[modelId].doLayout = false;
                }
            }
        });

        // Hide the tab component. It will get visible when the graps are loaded.
        $("#tabs").hide();

        //readGraphsFromFile("Login.gw3");
        //readGraphsFromFile("UC01.gw3");
        readGraphsFromFile("PetClinic.gw3");
    });


    function createTab(modelId, modelName) {
        console.log("createTab: " + modelId + ", " + modelName);

        var tabs = $("#tabs").tabs();
        var ul = tabs.find("ul");

        // ID tokens must begin with a letter ([A-Za-z])
        // https://www.w3.org/TR/html401/types.html#type-name
        var href = "#A-" + modelId;
        $("<li><a href='" + href + "'>" + modelName + "</a><span class='ui-icon ui-icon-close'></span></li>").appendTo(ul);
        $("<div id='A-" + modelId + "'></div>").appendTo(tabs);
        tabs.tabs("refresh");

        $("<style>").prop("type", "text/css").html("\
                    " + href + " {\
                        background: floralwhite;\
                        position: relative;\
                        height:100%;\
                        overflow-y: hidden;\
                    }").appendTo("head");

        return createGraph(modelId);
    }

    function createGraph(currentModelId) {
        console.log("createGraph - " + currentModelId);

        var graph = cytoscape({
            id: currentModelId,
            container: document.querySelector('#A-' + currentModelId),

            boxSelectionEnabled: true,
            'wheelSensitivity': '0', // Values 0, 0.5 and 1 has the same effect...

            style: cytoscape.stylesheet()
                    .selector('core')
                    .css({
                        //'active-bg-size': 0 // remove the grey circle when panning
                    })
                    .selector('node')
                    .css({
                        'content': 'data(name)',
                        'text-wrap': 'wrap',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'shape': 'roundrectangle',
                        'width': 'label',
                        'height': 'label',
                        'color': 'black',
                        'background-color': 'LightSteelBlue  ',
                        'line-color': 'LightSteelBlue ',
                        'padding-left': '10',
                        'padding-right': '10',
                        'padding-top': '10',
                        'padding-bottom': '10'
                    })
                    .selector('edge')
                    .css({
                        'content': 'data(name)',
                        'text-wrap': 'wrap',
                        'curve-style' : 'unbundled-bezier',
//                        'edge-text-rotation': 'autorotate',
                        'target-arrow-shape': 'triangle',
                        'width': '4',
                        'line-color': 'LightSteelBlue',
                        'target-arrow-color': 'LightSteelBlue',
                        'background-color': 'LightSteelBlue'
                    })
                    .selector(':selected')
                    .css({
                        'background-color': 'MediumSlateBlue ',
                        'line-color': 'MediumSlateBlue ',
                        'target-arrow-color': 'MediumSlateBlue ',
                        'source-arrow-color': 'MediumSlateBlue '
                    })
        });

        graph.on("click", function(){
            graph.resize();
        });

        graphs[currentModelId] = graph;
        return graph;
    }

    function readGraphsFromFile(fileName) {
        console.log("readGraphFromFile - " + fileName);

        // Assign handlers immediately after making the request,
        // and remember the jqxhr object for this request
        var jqxhr = $.getJSON(fileName, function () {
                    console.log("readGraphsFromFile: success");
                })
                .done(function (jsonGraphs) {
                    console.log("readGraphsFromFile: done");
                    readGraphFromJSON(jsonGraphs);
                })
                .fail(function () {
                    console.log("readGraphsFromFile: error");
                })
                .always(function () {
                    console.log("readGraphsFromFile: first complete");
                    $("#tabs").show();
                    for (var key in graphs) {
                        console.log("readGraphsFromFile: resize graph: " + key);

                        var index = $('#tabs a[href="#A-' + key + '"]').parent().index();
                        $("#tabs").tabs("option", "active", index);

                        graphs[key].resize();
                        graphs[key].doLayout = true;
                    }
                });
    }

    function readGraphFromJSON(jsonGraphs) {
        var jsonModels = jsonGraphs.models;
        var graphs = [];

        for (var modelIndex = 0; modelIndex < jsonModels.length; modelIndex++) {
            var jsonModel = jsonModels[modelIndex];

            var id, name;
            if (jsonModel.hasOwnProperty('id')) {
                id = jsonModel.id;
            } else {
                id = generateUUID();
            }
            if (jsonModel.hasOwnProperty('name')) {
                name = jsonModel.name;
            } else {
                name = "Model: " + modelIndex;
            }
            var graph = createTab(id, name);

            graph.generator = jsonModel.generator;

            if (jsonModel.hasOwnProperty('startElementId')) {
                graph.startElementId = jsonModel.startElementId;
            }
            if (jsonModel.hasOwnProperty('actions')) {
                graph.actions = jsonModel.actions;
            }

            var jsonVertices = jsonModel.vertices;
            for (var i = 0; i < jsonVertices.length; i++) {
                var jsonVertex = jsonVertices[i];
                var x = 0, y = 0;
                if (jsonVertex.properties != undefined) {
                    if (jsonVertex.properties["x"] != undefined) {
                        x = jsonVertex.properties["x"];
                    }
                    if (jsonVertex.properties["y"] != undefined) {
                        y = jsonVertex.properties["y"];
                    }
                } else {
                    jsonVertex.properties = {};
                }

                graph.add({
                    group: "nodes",
                    data: {
                        id: jsonVertex.id,
                        label: jsonVertex.name,
                        name: stripEmptyLines([jsonVertex.name,
                            jsonVertex.actions,
                            jsonVertex.requirements]),
                        sharedState: jsonVertex.sharedState,
                        actions: jsonVertex.actions,
                        requirements: jsonVertex.requirements,
                        properties: jsonVertex.properties
                    },
                    position: {
                        x: x,
                        y: y
                    }
                });
            }
            var jsonEdges = jsonModel.edges;
            for (i = 0; i < jsonEdges.length; i++) {
                var jsonEdge = jsonEdges[i];

                // If source vertex is undefined, assume start vertex
                if (jsonEdge.sourceVertexId === undefined) {
                    jsonEdge.sourceVertexId = "Start";

                    graph.add({
                        group: "nodes",
                        data: {
                            id: jsonEdge.sourceVertexId,
                            name: "Start"
                        },
                        position: {
                            x: 0,
                            y: 0
                        },
                        css: {
                            'background-color': 'lightgreen'
                        }
                    });
                }

                graph.add({
                    group: "edges",
                    data: {
                        id: jsonEdge.id,
                        source: jsonEdge.sourceVertexId,
                        target: jsonEdge.targetVertexId,
                        label: jsonEdge.name,
                        name: stripEmptyLines([jsonEdge.name,
                            jsonEdge.guard,
                            jsonEdge.actions]),
                        guard: jsonEdge.guard,
                        actions: jsonEdge.actions,
                        requirements: jsonEdge.requirements,
                        properties: jsonEdge.properties
                    }
                });
            }
            graph.layout({ name: 'dagre',
                animate: true,
                minLen: function( edge ) {
                    return 2;
                }
            });
            graphs[graph.id] = graph;
        }
        return graphs;
    }

    function generateUUID() {
        console.log("generateUUID");
        var d = new Date().getTime();
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = (d + Math.random() * 16) % 16 | 0;
            d = Math.floor(d / 16);
            return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
        console.log("  UUID: " + uuid);
        return uuid;
    }

    function stripEmptyLines(strArrayWithLEmptyLines) {
        var str = "";
        for (var i = 0; i < strArrayWithLEmptyLines.length; i++) {
            if (strArrayWithLEmptyLines[i] !== undefined && strArrayWithLEmptyLines[i].length > 0) {
                str += strArrayWithLEmptyLines[i] + '\n';
            }
        }
        return str.slice(0, -1);
    }
</script>
</html>
