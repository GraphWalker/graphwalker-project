<html>
<head>
    <script type="text/javascript" src="dist/vis.min.js"></script>


    <script src="dist/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="dist/jquery-ui.min.js" type="text/javascript"></script>

    <!-- Optional custom library to enable 'taphold' events -->
    <script src="dist/taphold.js" type="text/javascript"></script>

    <!-- Finally this plugin itself -->
    <script src="dist/jquery.ui-contextmenu.js" type="text/javascript"></script>

    <script type="text/javascript" src="dist/jquery.hotkeys.js"></script>

    <link href="dist/vis.min.css" rel="stylesheet" type="text/css"/>
    <link href="dist/jquery-ui.css" type="text/css" rel="stylesheet"/>

    <style type="text/css">
        /* Fix the too large size of dialogs */
        body{
            font-size:11px;
        }
        /* Only for the demo */
        .hasmenu, .hasmenu2 {
            border: 1px solid #008;
            margin: 3px;
            padding: 5px;
            width: 30px;
        }

        /* Optionally define a fixed width for menus */
        .ui-menu {
            width: 220px;
        }

        /* Allow to use <kbd> elements inside the title to define shortcut hints. */
        .ui-menu kbd {
            padding-left: 1em;
            float: right;
        }

        #tabs { margin-top: 1em; }
        #tabs li .ui-icon-close { float: left; margin: 0.4em 0.2em 0 0; cursor: pointer; }

    </style>
</head>
<body>
<form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">
    <fieldset>
        <input type='file' id='files' name="files[]">
        <input id="inputFileNameToSaveAs">
        <button onclick="saveGraphAsFile(); return false;">Save</button>
        <div id="issues">No Issues</div>
        <button type='button' id="runModel" onclick="onRunModel()">Run model</button>
        <button type='button' id="resetModel" onclick="onResetModel()">Reset</button>
        <button type='button' id="pausePlayExecution" onclick="onPausePlayExecution(this)" value="Pause">Pause</button>
        <button type='button' id="stepExecution" onclick="onStepExecution()">Step</button>
        <button type='button' id="addVisNetwork" onclick="onAddVisNetwork()">Add Model</button>
    </fieldset>
</form>

<div id="tabs">
    <ul></ul>
</div>

<script type="text/javascript">
    "use strict";

    // Useful links
    // vis: http://visjs.org/
    // vis network doc: http://visjs.org/docs/network/
    // vis network examples: http://visjs.org/network_examples.html
    // vis data doc: http://visjs.org/docs/data/
    // 3rd part example: http://chris.neoxygen.io/articles/easy-graph-visualization-with-vis-dot-js.html

    /*
     ************************************************************************
     * SOME DATA INITIALIZATION, OTHER INIT. EXISTS ELSEWHERE IN CODE...
     ************************************************************************
     */
    var gw3 = '';
    var currentModelId = '';
    var modelIdList = [];
    var modelNamesList = [];
    var generatorList = [];
    var startElementIdList = [];
    var modelActionList = [];
    var optionsList = [];
    var visNetworkList = [];
    var dataList = [];
    var pauseExecution = false;
    var stepExecution = false;
    var contextNode;
    var contextEdge;
    var startNode;
    var undoList = [];
    var undoIndex = [];
    var keys = {};


    /*
     ************************************************************************
     * REACT TO SOME UI EVENTS
     ************************************************************************
     */
    function onPausePlayExecution(element) {
        console.log("pausePlayExecution: " + element.innerHTML + ", pauseExecution: " + pauseExecution + ", clicked: modelId " + currentModelId);
        stepExecution = false;

        if (pauseExecution) {
            document.getElementById("runModel").disabled = true;
            document.getElementById("resetModel").disabled = true;
            document.getElementById("pausePlayExecution").disabled = false;
            document.getElementById("stepExecution").disabled = true;
            document.getElementById("pausePlayExecution").innerHTML = "Pause";
            pauseExecution = false;

            var hasNext = {
                command: "hasNext"
            };
            doSend(JSON.stringify(hasNext));
        } else {
            document.getElementById("runModel").disabled = true;
            document.getElementById("resetModel").disabled = false;
            document.getElementById("pausePlayExecution").disabled = false;
            document.getElementById("stepExecution").disabled = false;
            document.getElementById("pausePlayExecution").innerHTML = "Run";
            pauseExecution = true;
        }
    };

    function onStepExecution() {
        console.log("stepExecution clicked: modelId " + currentModelId);
        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = false;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = false;
        stepExecution = true;

        var hasNext = {
            command: "hasNext"
        };
        doSend(JSON.stringify(hasNext));
    };

    // Run the execution of the state machine
    function onRunModel() {
        console.log("runModel clicked: modelId " + currentModelId);
        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = true;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = true;
        document.getElementById("addVisNetwork").disabled = true;
        stepExecution = false;
        pauseExecution = false;

        var start = {
            command: "start",
            gw3: {
                name: "VISMODEL",
                models: []
            }
        };
        for (var modelIndex = 0; modelIndex < modelIdList.length; modelIndex++) {
            var modelId = modelIdList[modelIndex];
            var model = {
                name: modelNamesList[modelId],
                id: modelId,
                generator: generatorList[modelId],
                actions: modelActionList[modelId],
                vertices: [],
                edges: []
            }

            if (startElementIdList[modelId] !== undefined) {
                model.startElementId = startElementIdList[modelId];
            }
            for (var i = 0; i < dataList[modelId].nodes.length; i++) {
                var nodeId = dataList[modelId].nodes.getIds()[i];
                var n = dataList[modelId].nodes.get(nodeId);
                var vertex = {
                    id: n.id,
                    name: n.name,
                    sharedState: n.sharedState,
                    actions: n.actions,
                    requirements: n.requirements,
                    properties: n.properties
                };
                model.vertices[i] = vertex;
            }
            for (i = 0; i < dataList[modelId].edges.length; i++) {
                var edgeId = dataList[modelId].edges.getIds()[i];
                var e = dataList[modelId].edges.get(edgeId);
                var edge = {
                    id: e.id,
                    name: e.name,
                    guard: e.guard,
                    actions: e.actions,
                    requirements: e.requirements,
                    properties: e.properties,
                    sourceVertexId: e.from,
                    targetVertexId: e.to
                };
                model.edges[i] = edge;
            }
            start.gw3.models.push(model);
        }


        doSend(JSON.stringify(start));
    };

    // Reset the state machine to it's initial state
    function onResetModel() {
        console.log("resetModel clicked: modelId " + currentModelId);
        defaultUI();

        for (var modelIndex = 0; modelIndex < modelIdList.length; modelIndex++)
        {
            var modelId = modelIdList[modelIndex];

            optionsList[modelId].nodes.color.background = "#97C2FC";
            optionsList[modelId].nodes.color.border = "#2A7BE8";
            optionsList[modelId].nodes.color.highlight.background = "#D2E5FF";
            optionsList[modelId].nodes.color.highlight.border = "#2B7CE9";
            optionsList[modelId].edges.color.color = "#2B7CE9";
            optionsList[modelId].edges.color.highlight = "#2B7CE9";
            visNetworkList[modelId].setOptions(optionsList[modelId]);

            for (var i = 0; i < dataList[modelId].nodes.length; i++) {
                var node = dataList[modelId].nodes.getIds()[i];
                if (node == startElementIdList[modelId]) {
                    dataList[modelId].nodes.update([{
                        id: node,
                        color: {
                            border: "#D7DF01",
                            background: "#FFFF00",
                            highlight: {
                                border: "#D7DFF1",
                                background: "#FFFFF0"
                            }
                        }
                    }]);
                } else if (node === "Start") {
                    dataList[modelId].nodes.update([{
                        id: node,
                        color: {
                            border: "#31B404",
                            background: "#00FF00",
                            highlight: {
                                border: "#31B404",
                                background: "#00FF00"
                            }
                        }
                    }]);
                } else {
                    dataList[modelId].nodes.update([{
                        id: node,
                        color: {
                            border: "#2A7BE8",
                            background: "#97C2FC",
                            highlight: {
                                border: "#2B7CE9",
                                background: "#D2E5FF"
                            }
                        }
                    }]);
                }
            }
            for (i = 0; i < dataList[modelId].edges.length; i++) {
                var edge = dataList[modelId].edges.getIds()[i];
                if (edge == startElementIdList[modelId]) {
                    dataList[modelId].edges.update([{
                        id: edge,
                        color: {
                            color: "#D7DF01",
                            highlight: "#D7DF01"
                        }
                    }]);
                } else {
                    dataList[modelId].edges.update([{
                        id: edge,
                        color: {
                            color: "#2B7CE9",
                            highlight: "#2B7CE9"
                        }
                    }]);
                }
            }
        }
    };

    // addTab button: just opens the dialog
    function onAddVisNetwork() {
        console.log("onAddVisNetwork clicked");
        currentModelId = generateUUID();
        modelNamesList[currentModelId] = "New Model"
        addTab();
        makeUndoCopy();
    };


    $(document).ready(function () {
        console.log("ready!");
        document.getElementById('files').addEventListener('change', handleFileSelect, false);

        // close icon: removing the tab on click
        $( "#tabs" ).delegate( "span.ui-icon-close", "click", function() {
            var id = $( this ).closest( "li" ).remove().attr( "aria-controls").substr(2);
            $( "#0-" + id ).remove();
            $( "#tabs" ).tabs( "refresh" );
            if ($("#tabs").find("li").length < 1) {
                $("#tabs").hide();
            }
            removeModel(id);
        });

        $("#tabs").tabs({
            beforeActivate: function (event, ui) {
                currentModelId = ui.newPanel.attr('id').substr(2);
                console.log("Tab: beforeActivate. Setting current model id to: " + currentModelId);
            }
        });

        $("#tabs").hide();

        $(document).keyup(function(e){
            console.log("key up: " + e.which);
            delete keys[e.which];
        });

        $(document).keydown(function(e){
            keys[e.which] = true;
            // ctrl + z - undo is pressed
            if(keys[17] !== undefined && keys[90] !== undefined ) {
                makeUndo();
            }
            // ctrl + y - redo is pressed
            else if(keys[17] !== undefined && keys[89] !== undefined ) {
                makeRedo();
            } else if (e.keyCode == 46) {
                console.log("Delete key down!");
                if (currentModelId !== undefined) {
                    var data = visNetworkList[currentModelId].getSelection();
                    if (data.edges.length > 0) {
                        dataList[currentModelId].edges.remove(data.edges);
                    }
                    if (data.nodes.length > 0) {
                        dataList[currentModelId].nodes.remove(data.nodes);
                    }
                    if (data.edges.length > 0 || data.nodes.length > 0) {
                        makeUndoCopy();
                    }
                }
            }
        });

        // Set some defaults on the UI
        defaultUI();
    });




    /*
     ************************************************************************
     * CREATE SOME CUSTOM EVENTS THAT HANDLES MODEL EXECUTION
     ************************************************************************
     */
    var startEvent = new CustomEvent("startEvent", {});
    document.addEventListener("startEvent", function (e) {
        console.log("startEvent: modelId " + currentModelId);

        // Change default coloring for nodes and edges.
        optionsList[currentModelId].nodes.color.highlight.background = "#669966";
        optionsList[currentModelId].nodes.color.highlight.border = "#669900";
        optionsList[currentModelId].edges.color.highlight = "#669966";
        visNetworkList[currentModelId].setOptions(optionsList[currentModelId]);

        // Change some UI elements
        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = true;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = true;

        var hasNext = {
            command: "hasNext"
        };
        doSend(JSON.stringify(hasNext));
    });

    var hasNextEvent = new CustomEvent("hasNextEvent", {});
    document.addEventListener("hasNextEvent", function (e) {
        console.log("hasNextEvent pauseExecution: " + pauseExecution + ", stepExecution: " + stepExecution + " : modelId " + currentModelId);
        if (pauseExecution) {
            if (!stepExecution) {
                return;
            }
        }
        var getNext = {
            command: "getNext"
        };
        doSend(JSON.stringify(getNext));
    });

    var getNextEvent = new CustomEvent("getNextEvent", {"modelId": "", "elementId": "", "name": ""});
    document.addEventListener("getNextEvent", function (e) {
        console.log("getNextEvent: " + e.id + ": " + e.name + "pauseExecution: " + pauseExecution + ", stepExecution: " + stepExecution + " : modelId " + currentModelId);

        if (stepExecution) {
            stepExecution = false;
            return;
        }

        var hasNext = {
            command: "hasNext"
        };
        setTimeout(function () {
            doSend(JSON.stringify(hasNext));
        }, 100);
    });

    function removeModel(modelId) {
        console.log("Remove model with id: " + modelId);

        delete modelNamesList[modelId];
        delete generatorList[modelId];
        delete startElementIdList[modelId];
        delete optionsList[modelId];
        delete visNetworkList[modelId];
        delete undoIndex[currentModelId];

        dataList[modelId].edges.clear();
        delete dataList[modelId].edges;

        dataList[modelId].nodes.clear();
        delete dataList[modelId].nodes;

        var index = modelIdList.indexOf(modelId);
        if (index > -1) {
            modelIdList.splice(index, 1);
        }
    }

    /*
     ************************************************************************
     * Save project to file
     ************************************************************************
     */
    function saveGraphAsFile() {
        console.log("saveGraphAsFile");
        var graphToWrite = {
            name: "VISMODEL",
            models: []
        };

        for (var modelId in modelNamesList) {
            var model = {
                name: modelNamesList[modelId],
                id: modelId,
                generator: generatorList[modelId],
                actions: modelActionList[modelId],
                vertices: [],
                edges: []
            };

            if (startElementIdList[modelId] !== undefined) {
                model.startElementId = startElementIdList[modelId];
            }

            for (var i = 0; i < dataList[modelId].nodes.length; i++) {
                var nodeId = dataList[modelId].nodes.getIds()[i];
                var n = dataList[modelId].nodes.get(nodeId);
                n.properties["x"] = n.x;
                n.properties["y"] = n.y;
                var vertex = {
                    id: n.id,
                    name: n.name,
                    sharedState: n.sharedState,
                    actions: n.actions,
                    requirements: n.requirements,
                    properties: n.properties
                };
                model.vertices[i] = vertex;
            }
            for (i = 0; i < dataList[modelId].edges.length; i++) {
                var edgeId = dataList[modelId].edges.getIds()[i];
                var e = dataList[modelId].edges.get(edgeId);
                var edge = {
                    id: e.id,
                    name: e.name,
                    guard: e.guard,
                    actions: e.actions,
                    requirements: e.requirements,
                    properties: e.properties,
                    sourceVertexId: e.from,
                    targetVertexId: e.to
                };
                model.edges[i] = edge;
            }
            graphToWrite.models.push(model);
        }


        var textFileAsBlob = new Blob([JSON.stringify(graphToWrite)], {type: 'application/json'});
        var fileNameToSaveAs = document.getElementById("inputFileNameToSaveAs").value;

        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        if (window.URL !== null) {
            // Chrome allows the link to be clicked
            // without actually adding it to the DOM.
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
        }
        else {
            // Firefox requires the link to be added to the DOM
            // before it can be clicked.
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
        }

        downloadLink.click();
    }

    /*
     ************************************************************************
     * Read project from file
     ************************************************************************
     */
    function handleFileSelect(evt) {
        console.log("handleFileSelect");
        var fr;
        var file = evt.target.files[0];

        for (var modelId in dataList) {
            removeModel(modelId);
            var index = $('#tabs a[href="#0-' + modelId + '"]').parent().index();
            $("#0-" + modelId).remove();
            $( "#tabs" ).find( ".ui-tabs-nav li:eq(" + index + ")" ).remove();
            $("#tabs").tabs( "refresh" );
        }

        fr = new FileReader();
        fr.onload = receivedText;
        fr.readAsText(file);
        console.log(fr);

        function receivedText(e) {
            var jsonLoadModel = JSON.parse(e.target.result);
            var jsonModels = jsonLoadModel.models;
            for (var modelIndex = 0; modelIndex < jsonModels.length; modelIndex++) {
                var jsonModel = jsonModels[modelIndex];

                if (jsonModel.hasOwnProperty('id')) {
                    currentModelId = jsonModel.id;
                } else {
                    currentModelId = generateUUID();
                }
                modelNamesList[currentModelId] = jsonModel.name;
                addTab();

                generatorList[currentModelId] = jsonModel.generator;

                if (jsonModel.hasOwnProperty('startElementId')) {
                    startElementIdList[currentModelId] = jsonModel.startElementId;
                }
                if (jsonModel.hasOwnProperty('actions')) {
                    modelActionList[currentModelId] = jsonModel.actions;
                }

                var jsonVertices = jsonModel.vertices;
                for (var i = 0; i < jsonVertices.length; i++) {
                    var jsonVertex = jsonVertices[i];
                    console.log(jsonVertex);
                    var x = 0, y = 0;
                    if (jsonVertex.properties != undefined) {
                        if (jsonVertex.properties["x"] != undefined) {
                            x = jsonVertex.properties["x"];
                        }
                        if (jsonVertex.properties["y"] != undefined) {
                            y = jsonVertex.properties["y"];
                        }
                    } else {
                        jsonVertex.properties = {};
                    }

                    dataList[currentModelId].nodes.add({
                        id: jsonVertex.id,
                        name: jsonVertex.name,
                        label: stripEmptyLines([jsonVertex.name,
                                                jsonVertex.actions,
                                                jsonVertex.requirements]),
                        sharedState: jsonVertex.sharedState,
                        actions: jsonVertex.actions,
                        requirements: jsonVertex.requirements,
                        properties: jsonVertex.properties,
                        x: x,
                        y: y
                    });
                }
                var jsonEdges = jsonModel.edges;
                for (i = 0; i < jsonEdges.length; i++) {
                    var jsonEdge = jsonEdges[i];
                    console.log(jsonEdge);

                    // If source vertex is undefined, assume start vertex
                    if (jsonEdge.sourceVertexId === undefined) {
                        jsonEdge.sourceVertexId = "Start";
                        dataList[currentModelId].nodes.add({
                            id: jsonEdge.sourceVertexId,
                            label: "Start",
                            x: 0,
                            y: 0
                        });
                    }

                    dataList[currentModelId].edges.add({
                        id: jsonEdge.id,
                        name: jsonEdge.name,
                        label: stripEmptyLines([jsonEdge.name,
                                                jsonEdge.guard,
                                                jsonEdge.actions]),
                        guard: jsonEdge.guard,
                        actions: jsonEdge.actions,
                        requirements: jsonEdge.requirements,
                        properties: jsonEdge.properties,
                        from: jsonEdge.sourceVertexId,
                        to: jsonEdge.targetVertexId,
                        arrows: 'to'
                    });
                }

                var index = $('#tabs a[href="#0-' + currentModelId + '"]').parent().index();
                $("#tabs").tabs("option", "active", index);
                visNetworkList[currentModelId].fit();
                onResetModel();
                makeUndoCopy();
            }
        }
    }





    /*
     ************************************************************************
     * WEBSOCKET CLIENT
     ************************************************************************
     */
    var wsUri = "ws://localhost:9999";
    var websocket;
    var messageState =
            testWebSocket();
    function testWebSocket() {
        websocket = new WebSocket(wsUri);
        websocket.onopen = function (evt) {
            onOpen(evt);
        };
        websocket.onclose = function (evt) {
            onClose(evt);
        };
        websocket.onmessage = function (evt) {
            onMessage(evt);
        };
        websocket.onerror = function (evt) {
            onError(evt);
        };
    }
    function onOpen(evt) {
        console.log('onOpen: ' + evt.data);
    }
    function onClose(evt) {
        console.log('onClose: ' + evt.data);
    }
    function onMessage(evt) {
        console.log(evt.data);
        var msg = JSON.parse(event.data);

        switch (msg.command) {
            case "hasNext":
                if (msg.success) {
                    console.log("Command hasNext: " + msg.hasNext);
                    if (msg.hasNext) {
                        hasNextEvent.fullfilled = msg.hasNext;
                        document.dispatchEvent(hasNextEvent);
                    } else {
                        defaultUI();
                        document.getElementById("runModel").disabled = true;
                    }
                } else {
                    defaultUI();
                }
                break;
            case "getNext":
                if (msg.success) {
                    console.log("Command getNext ok");
                    document.dispatchEvent(getNextEvent, msg.modelId, msg.elementId, msg.name);
                } else {
                    defaultUI();
                }
                break;
            case "start":
                if (msg.success) {
                    issues.innerHTML = "No issues";
                    console.log("Command start ok");
                    document.dispatchEvent(startEvent);
                } else {
                    defaultUI();
                }
                break;
            case "issues":
                issues.innerHTML = msg.issues;
                break;
            case "noIssues":
                issues.innerHTML = "No issues";
                break;
            case "visitedElement":
                console.log("Command visitedElement. Will color green on (modelId, elementId): " + msg.modelId + ", " + msg.elementId);
                issues.innerHTML = "Steps: " + msg.totalCount + ", Done: " + (msg.stopConditionFulfillment * 100).toFixed(0) + "%, data: " + JSON.stringify(msg.data);
                visNetworkList[currentModelId].unselectAll();

                currentModelId = msg.modelId;
                var index = $('#tabs a[href="#0-' + currentModelId + '"]').parent().index();
                $("#tabs").tabs("option", "active", index);

                if (dataList[currentModelId].nodes.get(msg.elementId) !== null) {
                    dataList[currentModelId].nodes.update([{
                        id: msg.elementId,
                        color: {
                            border: "#31B404",
                            background: "#00FF00",
                            highlight: {
                                border: "#31B404",
                                background: "#00FF00"
                            }
                        }
                    }]);
                    visNetworkList[currentModelId].selectNodes([msg.elementId], false);
                } else if (dataList[currentModelId].edges.get(msg.elementId) !== null) {
                    dataList[currentModelId].edges.update([{
                        id: msg.elementId,
                        color: {
                            color: "#31B404",
                            highlight: "#31B404"
                        }
                    }]);
                    visNetworkList[currentModelId].selectEdges([msg.elementId]);
                }
                break;
            default:
                break;
        }
    }
    function onError(evt) {
        console.error('Error: ' + evt.data);
    }
    function doSend(message) {
        console.log('Sending msgs: ' + message);
        websocket.send(message);
    }


    /*
     ************************************************************************
     * UTILITY FUNCTIONS
     ************************************************************************
     */
    function defaultUI() {
        console.log("defaultUI");

        if (modelIdList.length > 0 && currentModelId != undefined) {
            document.getElementById("runModel").disabled = false;
            document.getElementById("resetModel").disabled = false;
            document.getElementById("pausePlayExecution").disabled = true;
            document.getElementById("stepExecution").disabled = true;
            document.getElementById("pausePlayExecution").innerHTML = "Pause";
            document.getElementById("addVisNetwork").disabled = false;
        } else {
            document.getElementById("runModel").disabled = false;
            document.getElementById("resetModel").disabled = false;
            document.getElementById("pausePlayExecution").disabled = false;
            document.getElementById("stepExecution").disabled = false;
            document.getElementById("pausePlayExecution").innerHTML = "Pause";
            document.getElementById("addVisNetwork").disabled = false;
        }
    }

    function makeUndoCopy() {
        console.log("makeUndoCopy - undoIndex: " + undoIndex[currentModelId]);
        if (currentModelId === undefined) {
            return;
        }

        // Make a copy of the network data.The copy is stored in the undo list
        var data = {
            nodes: new vis.DataSet($.extend(true, [], dataList[currentModelId].nodes).get()),
            edges: new vis.DataSet($.extend(true, [], dataList[currentModelId].edges).get())
        };

        if (undoList[currentModelId] === undefined) {
            undoList[currentModelId] = [];
        }

        // If the undo index points to anywhere else than the end of the undo list,
        // truncate the undo list from that undo index.
        for (var i = undoList[currentModelId].length - undoIndex[currentModelId]; i > 1; i-- ) {
            undoList[currentModelId].pop();
        }

        // Put the copy in the undo list.
        //dataList[currentModelId] = data;
        undoIndex[currentModelId] = undoList[currentModelId].push(data) - 1;
        visNetworkList[currentModelId].setData(data);
        visNetworkList[currentModelId].redraw();
    }

    function makeUndo() {
        console.log("makeUndo - undoIndex: " + undoIndex[currentModelId] + "(" + undoList[currentModelId].length + ")");
        undoIndex[currentModelId]--;
        var data = undoList[currentModelId][undoIndex[currentModelId]];
        if (data === undefined) {
            undoIndex[currentModelId]++;
            return;
        }
        dataList[currentModelId].edges = new vis.DataSet($.extend(true, [], data.edges.get()));
        dataList[currentModelId].nodes = new vis.DataSet($.extend(true, [], data.nodes.get()));
        visNetworkList[currentModelId].setData(data);
        visNetworkList[currentModelId].redraw();
    }

    function makeRedo() {
        console.log("makeRedo - undoIndex: " + undoIndex[currentModelId] + "(" + undoList[currentModelId].length + ")");
        undoIndex[currentModelId]++;
        var data = undoList[currentModelId][undoIndex[currentModelId]];
        if (data === undefined) {
            undoIndex[currentModelId]--;
            return;
        }
        dataList[currentModelId].edges = new vis.DataSet($.extend(true, [], data.edges.get()));
        dataList[currentModelId].nodes = new vis.DataSet($.extend(true, [], data.nodes.get()));
        visNetworkList[currentModelId].setData(data);
        visNetworkList[currentModelId].redraw();
    }

    function stripEmptyLines(strArrayWithLEmptyLines) {
        var str = "";
        for (var i=0; i < strArrayWithLEmptyLines.length; i++) {
            if (strArrayWithLEmptyLines[i] !== undefined && strArrayWithLEmptyLines[i].length > 0) {
                str += strArrayWithLEmptyLines[i] + '\n';
            }
        }
        return str.slice(0, -1);
    }

    function generateUUID() {
        console.log("generateUUID");
        var d = new Date().getTime();
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = (d + Math.random() * 16) % 16 | 0;
            d = Math.floor(d / 16);
            return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
        console.log("  generated UUID: " + uuid);
        return uuid;
    }

    function addTab() {
        console.log("addTab");
        modelIdList.push(currentModelId);
        var href = "#0-" + currentModelId;

        var tabs = $("#tabs").tabs();
        var ul = tabs.find("ul");
        $("<li><a href='" + href +"'>" + modelNamesList[currentModelId] + "</a><span class='ui-icon ui-icon-close'></span></li>").appendTo(ul);
        $("<div id='0-" + currentModelId + "'></div>").appendTo(tabs);
        tabs.tabs("refresh");

        $("<style>").prop("type", "text/css").html("\
                    " + href + " {\
                        width: 100%;\
                        height: 100%;\
                        border: 1px solid #444444;\
                        background-color: #dddddd;\
                    }").appendTo("head");

        addVisNetwork();
        var index = $('#tabs a[href="#0-' + currentModelId + '"]').parent().index();
        $("#tabs").tabs("option", "active", index);
        $("#tabs").show();
    }


    /*
     ************************************************************************
     * VIS NETWORK INITIALIZATION
     ************************************************************************
     */
    function addVisNetwork() {
        console.log("addVisNetwork");
        var container = document.getElementById('0-' + currentModelId);

        var options = {
            interaction: {
                multiselect: true,
                selectConnectedEdges: false
            },
            manipulation: {
                enabled: false,
                initiallyActive: false
            },
            nodes: {
                physics: false,
                shape: 'box',
                shadow: true,
                color: {
                    border: '#2B7CE9',
                    background: '#97C2FC',
                    highlight: {
                        border: '#2B7CE9',
                        background: '#D2E5FF'
                    },
                    hover: {
                        border: '#2B7CE9',
                        background: '#D2E5FF'
                    }
                }
            },
            edges: {
                shadow: true,
                arrows: {
                    to: {
                        enabled: true,
                        scaleFactor: 1
                    }
                },
                smooth: true,
                color: {
                    color: '#2B7CE9',
                    highlight: '#2B7CE9',
                    hover: '#2B7CE9'
                }
            }
        };
        optionsList[currentModelId] = options;

        dataList[currentModelId] = {
            nodes: new vis.DataSet([]),
            edges: new vis.DataSet([])
        };

        visNetworkList[currentModelId] = new vis.Network(container, dataList[currentModelId], options);
        console.log("  Adding network: " + visNetworkList[currentModelId]);

        /*
         ************************************************************************
         * VIS EVENT HANDLING
         ************************************************************************
         */
        visNetworkList[currentModelId].on('oncontext', function (params) {
            console.log("oncontext: modelId " + currentModelId);
            params.event.preventDefault();
            console.log(visNetworkList[currentModelId].getPositions());

            contextNode = visNetworkList[currentModelId].getNodeAt(params.pointer.DOM);
            contextEdge = visNetworkList[currentModelId].getEdgeAt(params.pointer.DOM);
            console.log("Node: " + contextNode + ", Edge: " + contextEdge);

            if (contextNode != undefined) {
                var node = dataList[currentModelId].nodes.get(contextNode);
                $(function () {
                    $(document).contextmenu({
                        delegate: ".vis-network",
                        menu: [
                            {title: "Properties", cmd: "Properties"},
                            {title: "Delete", cmd: "Delete"}
                        ],
                        select: function (event, ui) {
                            switch (ui.cmd) {
                                case "Properties":
                                    $('<div id="dlg"></div>').dialog({
                                        modal: true,
                                        title: "Properties",
                                        open: function () {
                                            var markup ='<form>\
                                           <fieldset>\
                                             <legend>Vertex Properties:</legend>\
                                             Start element: <input type="checkbox" id="startElement"><br>\
                                             Blocked: <input type="checkbox" id="blocked"><br>\
                                             Name: <input type="text" id="name"><br>\
                                             Shared: <input type="text" id="shared"><br>\
                                             Actions: <input type="text" id="actions"><br>\
                                             Requirements: <input type="text" id="requirements"><br>\
                                           </fieldset>\
                                         </form>';

                                            $(this).html(markup);
                                            $("#name").val(node.name);
                                            $("#shared").val(node.sharedState);
                                            $("#actions").val(node.actions);
                                            $("#requirements").val(node.requirements);
                                            if (startElementIdList[currentModelId] == node.id) {
                                                $("#startElement").prop('checked', true);
                                            } else {
                                                $("#startElement").prop('checked', false);
                                            }

                                            if (node.hasOwnProperty("properties") && node.properties != undefined) {
                                                if (node.properties["blocked"]) {
                                                    $("#blocked").val(true);
                                                }
                                            }
                                        },
                                        close : function() {
                                            $(this).dialog( "close" );
                                            $(this).remove();
                                        },
                                        buttons: {
                                            'OK': function () {
                                                dataList[currentModelId].nodes.update(
                                                        {
                                                            id: node.id,
                                                            name: $("#name").val(),
                                                            sharedState: $("#shared").val(),
                                                            label: stripEmptyLines([$("#name").val(),
                                                                                    $("#actions").val(),
                                                                                    $("#requirements").val()]),
                                                            actions: $("#actions").val().split(","),
                                                            requirements: $("#requirements").val().split(","),
                                                            properties: {
                                                                blocked: $("#blocked").prop('checked')
                                                            }
                                                        });
                                                makeUndoCopy();
                                                if ($("#startElement").prop('checked')) {
                                                    startElementIdList[currentModelId] = node.id;
                                                }
                                                $(this).dialog( "close" );
                                                onResetModel();
                                            },
                                            'Cancel': function() {
                                                $(this).dialog( "close" );
                                            }
                                        }
                                    });
                                    break;
                                case "Delete":
                                    dataList[currentModelId].nodes.remove(node.id);
                                    break;
                            }
                        }
                    });
                });
            } else if (contextEdge != undefined) {
                var edge = dataList[currentModelId].edges.get(contextEdge);
                $(function () {
                    $(document).contextmenu({
                        delegate: ".vis-network",
                        menu: [
                            {title: "Properties", cmd: "Properties"},
                            {title: "Delete", cmd: "Delete"}
                        ],
                        select: function (event, ui) {
                            switch (ui.cmd) {
                                case "Properties":
                                    $('<div id="dlg"></div>').dialog({
                                        modal: true,
                                        title: "Properties",
                                        open: function () {
                                            var markup = '<form>\
                                                           <fieldset>\
                                                             <legend>Edge Properties:</legend>\
                                                             Start element: <input type="checkbox" id="startElement"><br>\
                                                             Blocked: <input type="checkbox" id="blocked"><br>\
                                                             Name: <input type="text" id="name"><br>\
                                                             Guard: <input type="text" id="guard"><br>\
                                                             Actions: <input type="text" id="actions"><br>\
                                                             Requirements: <input type="text" id="requirements"><br>\
                                                           </fieldset>\
                                                         </form>';

                                            $(this).html(markup);
                                            $("#name").val(edge.name);
                                            $("#guard").val(edge.guard);
                                            $("#actions").val(edge.actions);
                                            $("#requirements").val(edge.requirements);
                                            if (startElementIdList[currentModelId] == edge.id) {
                                                $("#startElement").prop('checked', true);
                                            } else {
                                                $("#startElement").prop('checked', false);
                                            }
                                        },
                                        close: function () {
                                            $(this).dialog("close");
                                            $(this).remove();
                                        },
                                        buttons: {
                                            'OK': function () {
                                                dataList[currentModelId].edges.update(
                                                        {
                                                            id: edge.id,
                                                            name: $("#name").val(),
                                                            label: stripEmptyLines([$("#name").val(),
                                                                                    $("#guard").val(),
                                                                                    $("#actions").val()]),
                                                            guard: $("#guard").val(),
                                                            actions: $("#actions").val().split(","),
                                                            requirements: $("#requirements").val().split(","),
                                                            properties: {
                                                                blocked: $("#blocked").prop('checked')
                                                            }
                                                        });
                                                makeUndoCopy();
                                                if ($("#startElement").prop('checked')) {
                                                    startElementIdList[currentModelId] = edge.id;
                                                }
                                                $(this).dialog("close");
                                                onResetModel();
                                            },
                                            'Cancel': function () {
                                                $(this).dialog("close");
                                            }
                                        }
                                    });
                                    break;
                                case "Delete":
                                    dataList[currentModelId].edges.remove(edge.id);
                                    break;
                            }
                        }
                    });
                });
            } else {
                $(function () {
                    $(document).contextmenu({
                        delegate: ".vis-network",
                        menu: [
                            {title: "Properties", cmd: "Properties"}
                        ],
                        select: function (event, ui) {
                            switch (ui.cmd) {
                                case "Properties":
                                    $('<div id="dlg"></div>').dialog({
                                        modal: true,
                                        title: "Properties",
                                        open: function () {
                                            var markup ='<form>\
                                           <fieldset>\
                                             <legend>Model Properties:</legend>\
                                             Name: <input type="text" id="name"><br>\
                                             Generator: <input type="text" id="generator"><br>\
                                           </fieldset>\
                                         </form>';

                                            $(this).html(markup);
                                            $("#name").val(modelNamesList[currentModelId]);
                                            $("#generator").val(generatorList[currentModelId]);
                                        },
                                        close : function() {
                                            $(this).dialog( "close" );
                                            $(this).remove();
                                        },
                                        buttons: {
                                            'OK': function () {
                                                modelNamesList[currentModelId] = $("#name").val();
                                                generatorList[currentModelId] = $("#generator").val();
                                                $(this).dialog( "close" );
                                                onResetModel();
                                            },
                                            'Cancel': function() {
                                                $(this).dialog( "close" );
                                            }
                                        }
                                    });
                                    break;
                            }
                        }
                    });
                });
            }
        });

        visNetworkList[currentModelId].on('dragStart', function (params) {
            console.log("dragStart: " + currentModelId);
            if(keys[17] !== undefined) {
                startNode = visNetworkList[currentModelId].findNode(visNetworkList[currentModelId].getNodeAt(params.pointer.DOM))[0];
                console.log("  startNode: " + startNode);
            }
        });

        visNetworkList[currentModelId].on('dragging', function (params) {
            console.log("dragging: " + currentModelId);
            if(keys[17] !== undefined) {
                preventDefault();
            }
        });

        visNetworkList[currentModelId].on('dragEnd', function (params) {
            console.log("dragEnd: " + currentModelId);
            var node = visNetworkList[currentModelId].findNode(visNetworkList[currentModelId].getNodeAt(params.pointer.DOM))[0];
            if (node !== undefined) {
                if(keys[17] !== undefined) {
                    if ( startNode !== undefined) {
                        dataList[currentModelId].edges.add({
                            id: generateUUID(),
                            label: "e_NewEdge",
                            name: "e_NewEdge",
                            from: startNode.id,
                            to: node.id,
                            arrows: 'to'
                        });
                    }
                } else {
                    dataList[currentModelId].nodes.update({
                        id: node.id,
                        x: params.pointer.canvas.x,
                        y: params.pointer.canvas.y
                    });
                }
                makeUndoCopy();
            }
        });

        visNetworkList[currentModelId].on('click', function (params) {
            console.log("click: " + currentModelId);
            if(keys[17] !== undefined) {
                startNode = visNetworkList[currentModelId].findNode(visNetworkList[currentModelId].getNodeAt(params.pointer.DOM))[0];
                console.log("  startNode: " + startNode);
            }
        });

        visNetworkList[currentModelId].on('doubleClick', function (params) {
            console.log("doubleClick: " + currentModelId);
            var node = visNetworkList[currentModelId].getNodeAt(params.pointer.DOM);
            var edge = visNetworkList[currentModelId].getEdgeAt(params.pointer.DOM);
            if (node == undefined && edge == undefined) {
                dataList[currentModelId].nodes.add({
                    id: generateUUID(),
                    label: 'v_NewVertex',
                    name: 'v_NewVertex',
                    x: params.pointer.canvas.x,
                    y: params.pointer.canvas.y
                });
                makeUndoCopy();
            }
        });

        dataList[currentModelId].nodes.on('*', function (event, properties, senderId) {
            console.log('nodes data update event:', event, 'properties:', JSON.stringify(properties), 'senderId:', senderId);
        });

        dataList[currentModelId].edges.on('*', function (event, properties, senderId) {
            console.log('edges data update event:', event, 'properties:', JSON.stringify(properties), 'senderId:', senderId);
        });
    }

</script>
</body>
</html>
