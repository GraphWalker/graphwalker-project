<html>
<head>
    <meta charset=utf-8/>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.12.0.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.js"></script>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">

    <script type="text/javascript" src="dist/cytoscape.js"></script>

    <script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.1.2/cytoscape-dagre.js"></script>

    <style type="text/css">
        body {
            font: 14px helvetica neue, helvetica, arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #tabs {
            position: absolute;
            top: 0;
            bottom:0;
            left: 0;
            right: 0;
            overflow:hidden;
        }

        #tabs div {
            height: 100%;
        }

        #tabs li .ui-icon-close {
            float: left;
            margin: 0.4em 0.2em 0 0;
            cursor: pointer;
        }

        .ui-tabs .ui-tabs-panel {
            padding: 0;
        }
    </style>
</head>
<body>
<div data-role="page" id="panel-fixed-page1">
    <div data-role="header" data-theme="b" data-position="fixed">
        <h1>GraphWalker Studio</h1>
        <a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
        <a href="#add-form" data-icon="gear" data-iconpos="notext">Add</a>
    </div>

    <div data-role="content" class="jqm-content">
        <div id="tabs">
            <ul></ul>
        </div>
        <div data-demo-html="#panel-fixed-page1" data-demo-css="true"></div>
    </div>

    <div data-role="footer" data-position="fixed" data-theme="b">
        <h4 id="issues">Fixed footer</h4>
    </div><!-- /footer -->

    <div data-role="panel" data-position-fixed="true" data-theme="a" id="nav-panel">
        <ul data-role="listview" data-theme="a" class="nav-search">
            <li data-icon="delete"><a href="#" data-rel="close">Close menu</a></li>
            <li><button type='button' id="runModel" onclick="onRunModel()">Run model</button></li>
            <li><button type='button' id="resetModel" onclick="onResetModel()">Reset</button></li>
            <li><button type='button' id="pausePlayExecution" onclick="onPausePlayExecution(this)" value="Pause">Pause</button></li>
            <li><button type='button' id="stepExecution" onclick="onStepExecution()">Step</button></li>
            <li><button type='button' id="addModel" onclick="onAddModel()">Add Model</button></li>
        </ul>
    </div>

    <div data-role="panel" data-position="right" data-position-fixed="true" data-display="overlay" data-theme="b"
         id="add-form">
        <form class="userform">
            <h2>Login</h2>
            <label for="name">Username:</label>
            <input type="text" name="name" id="name" value="" data-clear-btn="true" data-mini="true">
            <label for="password">Password:</label>
            <input type="password" name="password" id="password" value="" data-clear-btn="true" autocomplete="off"
                   data-mini="true">
            <div class="ui-grid-a">
                <div class="ui-block-a"><a href="#" data-rel="close" data-role="button" data-theme="c" data-mini="true">Cancel</a>
                </div>
                <div class="ui-block-b"><a href="#" data-rel="close" data-role="button" data-theme="b" data-mini="true">Save</a>
                </div>
            </div>
        </form>
    </div>
</div>
</body>

<script>
    // Hash array that holds all graphs/models.
    var graphs =[];
    var currentModelId = undefined;
    var pauseExecution = false;
    var stepExecution = false;


    function onPausePlayExecution(element) {
        console.log("pausePlayExecution: " + element.innerHTML + ", pauseExecution: " + pauseExecution + ", clicked: " + currentModelId);
        stepExecution = false;

        if (pauseExecution) {
            document.getElementById("runModel").disabled = true;
            document.getElementById("resetModel").disabled = true;
            document.getElementById("pausePlayExecution").disabled = false;
            document.getElementById("stepExecution").disabled = true;
            document.getElementById("pausePlayExecution").innerHTML = "Pause";
            pauseExecution = false;

            var hasNext = {
                command: "hasNext"
            };
            doSend(JSON.stringify(hasNext));
        } else {
            document.getElementById("runModel").disabled = true;
            document.getElementById("resetModel").disabled = false;
            document.getElementById("pausePlayExecution").disabled = false;
            document.getElementById("stepExecution").disabled = false;
            document.getElementById("pausePlayExecution").innerHTML = "Run";
            pauseExecution = true;
        }
    };

    function onStepExecution() {
        console.log("onStepExecution: " + currentModelId);
        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = false;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = false;
        stepExecution = true;

        var hasNext = {
            command: "hasNext"
        };
        doSend(JSON.stringify(hasNext));
    };

    // Run the execution of the state machine
    function onRunModel() {
        console.log("onRunModel: " + currentModelId);
        $( ".ui-panel" ).panel( "close" );

        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = true;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = true;
        stepExecution = false;
        pauseExecution = false;

        var start = {
            command: "start",
            gw3: {
                name: "GraphWalker Studio",
                models: []
            }
        };
        for (var modelId in graphs) {
            var model = {
                name: graphs[modelId].name,
                id: modelId,
                generator: graphs[modelId].generator,
                actions: graphs[modelId].actions,
                vertices: [],
                edges: []
            }

            if (graphs[modelId].startElementId !== undefined) {
                model.startElementId = graphs[modelId].startElementId;
            }
            graphs[modelId].nodes().each( function( index, node) {
                var vertex = {
                    id: node.data().id,
                    name: node.data().name,
                    sharedState: node.data().sharedState,
                    actions: node.data().actions,
                    requirements: node.data().requirements,
                    properties: node.data().properties
                };
                model.vertices.push(vertex);
            });
            graphs[modelId].edges().each( function( index, edge) {
                var edge = {
                    id: edge.data().id,
                    name: edge.data().name,
                    guard: edge.data().guard,
                    actions: edge.data().actions,
                    requirements: edge.data().requirements,
                    properties: edge.data().properties,
                    sourceVertexId: edge.data().source,
                    targetVertexId: edge.data().target
                };
                model.edges.push(edge);
            });
            start.gw3.models.push(model);
        }

        doSend(JSON.stringify(start));
    };

    // Reset the state machine to it's initial state
    function onResetModel() {
        console.log("onResetModel: " + currentModelId);
        defaultUI();

        for (var modelId in graphs) {
        }
    };

    // addTab button: just opens the dialog
    function onAddModel() {
        console.log("onAddModel");
/*        currentModelId = generateUUID();
        modelNamesList[currentModelId] = "New Model"
        addTab();
        makeUndoCopy();*/
    };



    /*
     ************************************************************************
     * CREATE SOME CUSTOM EVENTS THAT HANDLES MODEL EXECUTION
     ************************************************************************
     */
    var startEvent = new CustomEvent("startEvent", {});
    document.addEventListener("startEvent", function (e) {
        console.log("startEvent: " + currentModelId);

        // Change some UI elements
        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = true;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = true;

        var hasNext = {
            command: "hasNext"
        };
        doSend(JSON.stringify(hasNext));
    });

    var hasNextEvent = new CustomEvent("hasNextEvent", {});
    document.addEventListener("hasNextEvent", function (e) {
        console.log("hasNextEvent: pauseExecution: " + pauseExecution + ", stepExecution: " + stepExecution + " : modelId " + currentModelId);
        if (pauseExecution) {
            if (!stepExecution) {
                return;
            }
        }
        var getNext = {
            command: "getNext"
        };
        doSend(JSON.stringify(getNext));
    });

    var getNextEvent = new CustomEvent("getNextEvent", {"modelId": "", "elementId": "", "name": ""});
    document.addEventListener("getNextEvent", function (e) {
        console.log("getNextEvent: " + e.id + ": " + e.name + "pauseExecution: " + pauseExecution + ", stepExecution: " + stepExecution + " : modelId " + currentModelId);

        if (stepExecution) {
            stepExecution = false;
            return;
        }

        var hasNext = {
            command: "hasNext"
        };
        setTimeout(function () {
            doSend(JSON.stringify(hasNext));
        }, 100);
    });

    function removeModel(modelId) {
        console.log("Remove model with id: " + modelId);

        delete graphs[modelId];
    }


    document.addEventListener('DOMContentLoaded', function () {

        $("#tabs").delegate("span.ui-icon-close", "click", function () {
            var id = $(this).closest("li").remove().attr("aria-controls").substr(2);
            $("#A-" + id).remove();
            $("#tabs").tabs("refresh");
            if ($("#tabs").find("li").length < 1) {
                $("#tabs").hide();
            }
            removeModel(id);
        });

        $('#tabs').tabs({
            activate: function (event, ui) {
                currentModelId = ui.newPanel.attr('id').substr(2);
                console.log("tabs activate: " + currentModelId);
                graphs[currentModelId].resize();
                if (graphs[currentModelId].doLayout) {
                    graphs[currentModelId].layout();
                    graphs[currentModelId].doLayout = false;
                }
            }
        });

        // Hide the tab component. It will get visible when the graps are loaded.
        $("#tabs").hide();

        //readGraphsFromFile("Login.gw3");
        //readGraphsFromFile("UC01.gw3");
        readGraphsFromFile("PetClinic.gw3");
    });


    function createTab(modelId, modelName) {
        console.log("createTab: " + modelId + ", " + modelName);

        var tabs = $("#tabs").tabs();
        var ul = tabs.find("ul");

        // ID tokens must begin with a letter ([A-Za-z])
        // https://www.w3.org/TR/html401/types.html#type-name
        var href = "#A-" + modelId;
        $("<li><a href='" + href + "'>" + modelName + "</a><span class='ui-icon ui-icon-close'></span></li>").appendTo(ul);
        $("<div id='A-" + modelId + "'></div>").appendTo(tabs);
        tabs.tabs("refresh");

        $("<style>").prop("type", "text/css").html("\
                    " + href + " {\
                        background: floralwhite;\
                        position: relative;\
                        height:100%;\
                        overflow-y: hidden;\
                    }").appendTo("head");

        return createGraph(modelId);
    }

    function createGraph(currentModelId) {
        console.log("createGraph - " + currentModelId);

        var graph = cytoscape({
            id: currentModelId,
            container: document.querySelector('#A-' + currentModelId),

            boxSelectionEnabled: true,
            'wheelSensitivity': '0', // Values 0, 0.5 and 1 has the same effect...

            style: cytoscape.stylesheet()
                    .selector('core')
                    .css({
                        //'active-bg-size': 0 // remove the grey circle when panning
                    })
                    .selector('node')
                    .css({
                        'content': 'data(name)',
                        'text-wrap': 'wrap',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'shape': 'roundrectangle',
                        'width': 'label',
                        'height': 'label',
                        'color': 'black',
                        'background-color': 'LightSteelBlue',
                        'line-color': 'LightSteelBlue ',
                        'padding-left': '10',
                        'padding-right': '10',
                        'padding-top': '10',
                        'padding-bottom': '10'
                    })
                    .selector('edge')
                    .css({
                        'content': 'data(name)',
                        'text-wrap': 'wrap',
                        'curve-style' : 'unbundled-bezier',
//                        'edge-text-rotation': 'autorotate',
                        'target-arrow-shape': 'triangle',
                        'width': '4',
                        'line-color': 'LightSteelBlue',
                        'target-arrow-color': 'LightSteelBlue',
                        'background-color': 'LightSteelBlue'
                    })
                    .selector(':selected')
                    .css({
                        'background-color': 'MediumSlateBlue ',
                        'line-color': 'MediumSlateBlue ',
                        'target-arrow-color': 'MediumSlateBlue '
                    })
        });

        graph.on("click", function(){
            graph.resize();
        });

        graphs[currentModelId] = graph;
        return graph;
    }

    function readGraphsFromFile(fileName) {
        console.log("readGraphFromFile - " + fileName);

        // Assign handlers immediately after making the request,
        // and remember the jqxhr object for this request
        var jqxhr = $.getJSON(fileName, function () {
                    console.log("readGraphsFromFile: success");
                })
                .done(function (jsonGraphs) {
                    console.log("readGraphsFromFile: done");
                    readGraphFromJSON(jsonGraphs);
                })
                .fail(function () {
                    console.log("readGraphsFromFile: error");
                })
                .always(function () {
                    console.log("readGraphsFromFile: first complete");
                    $("#tabs").show();
                    for (var key in graphs) {
                        console.log("readGraphsFromFile: resize graph: " + key);

                        var index = $('#tabs a[href="#A-' + key + '"]').parent().index();
                        $("#tabs").tabs("option", "active", index);

                        graphs[key].resize();
                        graphs[key].doLayout = true;
                    }
                });
    }

    function readGraphFromJSON(jsonGraphs) {
        var jsonModels = jsonGraphs.models;
        var graphs = [];

        for (var modelIndex = 0; modelIndex < jsonModels.length; modelIndex++) {
            var jsonModel = jsonModels[modelIndex];

            var id, name;
            if (jsonModel.hasOwnProperty('id')) {
                id = jsonModel.id;
            } else {
                id = generateUUID();
            }
            if (jsonModel.hasOwnProperty('name')) {
                name = jsonModel.name;
            } else {
                name = "Model: " + modelIndex;
            }
            var graph = createTab(id, name);

            graph.generator = jsonModel.generator;

            if (jsonModel.hasOwnProperty('startElementId')) {
                graph.startElementId = jsonModel.startElementId;
            }
            if (jsonModel.hasOwnProperty('actions')) {
                graph.actions = jsonModel.actions;
            }

            var jsonVertices = jsonModel.vertices;
            for (var i = 0; i < jsonVertices.length; i++) {
                var jsonVertex = jsonVertices[i];
                var x = 0, y = 0;
                if (jsonVertex.properties != undefined) {
                    if (jsonVertex.properties["x"] != undefined) {
                        x = jsonVertex.properties["x"];
                    }
                    if (jsonVertex.properties["y"] != undefined) {
                        y = jsonVertex.properties["y"];
                    }
                } else {
                    jsonVertex.properties = {};
                }

                graph.add({
                    group: "nodes",
                    data: {
                        id: jsonVertex.id,
                        label: jsonVertex.name,
                        name: stripEmptyLines([jsonVertex.name,
                            jsonVertex.actions,
                            jsonVertex.requirements]),
                        sharedState: jsonVertex.sharedState,
                        actions: jsonVertex.actions,
                        requirements: jsonVertex.requirements,
                        properties: jsonVertex.properties
                    },
                    position: {
                        x: x,
                        y: y
                    }
                });
            }
            var jsonEdges = jsonModel.edges;
            for (i = 0; i < jsonEdges.length; i++) {
                var jsonEdge = jsonEdges[i];

                // If source vertex is undefined, assume start vertex
                if (jsonEdge.sourceVertexId === undefined) {
                    jsonEdge.sourceVertexId = "Start";

                    graph.add({
                        group: "nodes",
                        data: {
                            id: jsonEdge.sourceVertexId,
                            name: "Start"
                        },
                        position: {
                            x: 0,
                            y: 0
                        },
                        css: {
                            'background-color': 'lightgreen'
                        }
                    });
                }

                graph.add({
                    group: "edges",
                    data: {
                        id: jsonEdge.id,
                        source: jsonEdge.sourceVertexId,
                        target: jsonEdge.targetVertexId,
                        label: jsonEdge.name,
                        name: stripEmptyLines([jsonEdge.name,
                            jsonEdge.guard,
                            jsonEdge.actions]),
                        guard: jsonEdge.guard,
                        actions: jsonEdge.actions,
                        requirements: jsonEdge.requirements,
                        properties: jsonEdge.properties
                    }
                });
            }
            graph.layout({ name: 'dagre',
                animate: true,
                minLen: function( edge ) {
                    return 2;
                }
            });
            graphs[graph.id] = graph;
        }
        return graphs;
    }

    function defaultUI() {
        console.log("defaultUI");

        if (graphs.length > 0 && currentModelId != undefined) {
            document.getElementById("runModel").disabled = false;
            document.getElementById("resetModel").disabled = false;
            document.getElementById("pausePlayExecution").disabled = true;
            document.getElementById("stepExecution").disabled = true;
            document.getElementById("pausePlayExecution").innerHTML = "Pause";
            document.getElementById("addModel").disabled = false;
        } else {
            document.getElementById("runModel").disabled = false;
            document.getElementById("resetModel").disabled = false;
            document.getElementById("pausePlayExecution").disabled = false;
            document.getElementById("stepExecution").disabled = false;
            document.getElementById("pausePlayExecution").innerHTML = "Pause";
            document.getElementById("addModel").disabled = false;
        }
    }

    function generateUUID() {
        console.log("generateUUID");
        var d = new Date().getTime();
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = (d + Math.random() * 16) % 16 | 0;
            d = Math.floor(d / 16);
            return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
        console.log("  UUID: " + uuid);
        return uuid;
    }

    function stripEmptyLines(strArrayWithLEmptyLines) {
        var str = "";
        for (var i = 0; i < strArrayWithLEmptyLines.length; i++) {
            if (strArrayWithLEmptyLines[i] !== undefined && strArrayWithLEmptyLines[i].length > 0) {
                str += strArrayWithLEmptyLines[i] + '\n';
            }
        }
        return str.slice(0, -1);
    }


    /*************************************************************************
     *
     * WEBSOCKET CLIENT TO GRAPHWALKER
     *
     *************************************************************************/
    var wsUri = "ws://localhost:9999";
    var websocket;
    var messageState = testWebSocket();
    function testWebSocket() {
        websocket = new WebSocket(wsUri);
        websocket.onopen = function (evt) {
            onOpen(evt);
        };
        websocket.onclose = function (evt) {
            onClose(evt);
        };
        websocket.onmessage = function (evt) {
            onMessage(evt);
        };
        websocket.onerror = function (evt) {
            onError(evt);
        };
    }
    function onOpen(evt) {
        console.log('onOpen: ' + evt.data);
    }
    function onClose(evt) {
        console.log('onClose: ' + evt.data);
    }
    function onMessage(evt) {
        console.log("onMessage: " + evt.data);
        var msg = JSON.parse(event.data);

        switch (msg.command) {
            case "hasNext":
                if (msg.success) {
                    console.log("Command hasNext: " + msg.hasNext);
                    if (msg.hasNext) {
                        hasNextEvent.fullfilled = msg.hasNext;
                        document.dispatchEvent(hasNextEvent);
                    } else {
                        defaultUI();
                        document.getElementById("runModel").disabled = true;
                    }
                } else {
                    defaultUI();
                }
                break;
            case "getNext":
                if (msg.success) {
                    console.log("Command getNext ok");
                    document.dispatchEvent(getNextEvent, msg.modelId, msg.elementId, msg.name);
                } else {
                    defaultUI();
                }
                break;
            case "start":
                if (msg.success) {
                    issues.innerHTML = "No issues";
                    console.log("Command start ok");
                    document.dispatchEvent(startEvent);
                } else {
                    defaultUI();
                }
                break;
            case "issues":
                issues.innerHTML = msg.issues;
                break;
            case "noIssues":
                issues.innerHTML = "No issues";
                break;
            case "visitedElement":
                console.log("Command visitedElement. Will color green on (modelId, elementId): " + msg.modelId + ", " + msg.elementId);
                issues.innerHTML = "Steps: " + msg.totalCount + ", Done: " + (msg.stopConditionFulfillment * 100).toFixed(0) + "%, data: " + JSON.stringify(msg.data);

                currentModelId = msg.modelId;
                graphs[currentModelId].nodes().unselect();
                graphs[currentModelId].edges().unselect();

                var index = $('#tabs a[href="#A-' + currentModelId + '"]').parent().index();
                $("#tabs").tabs("option", "active", index);

                //graphs[currentModelId].$('#'+msg.elementId).style('background-color', 'lightgreen');
                //graphs[currentModelId].$('#'+msg.elementId).style('line-color', 'lightgreen');
                //graphs[currentModelId].$('#'+msg.elementId).style('target-arrow-color', 'lightgreen');

                graphs[currentModelId].$('#'+msg.elementId).select();
                break;
            default:
                break;
        }
    }
    function onError(evt) {
        console.error('Error: ' + evt.data);
    }
    function doSend(message) {
        console.log('Sending msgs: ' + message);
        websocket.send(message);
    }
</script>
</html>
